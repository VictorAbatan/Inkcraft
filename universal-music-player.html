<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inkcraft Music Player</title>
  <link rel="icon" href="data:,">
</head>
<body>
  <audio id="bg-music" preload="auto"></audio>

  <script>
    // === PLAYLIST ===
    const playlist = [
      'Laufey_-_From_The_Start_CeeNaija.com_.mp3',
      'space-ambient-351305.mp3',
      'space-ambient-cinematic-351304.mp3'
    ];

    const audio = document.getElementById('bg-music');
    const audioNext = new Audio();
    audioNext.preload = 'auto';
    audioNext.loop = false;
    audioNext.volume = 0;

    let current = 0;
    let isPlaying = false;
    let wasPlayingBeforeLeaving = false;

    // === ðŸ”¹ Load saved state from localStorage ===
    const savedTrack = localStorage.getItem('inkcraft-music-track');
    const savedTime = parseFloat(localStorage.getItem('inkcraft-music-time') || 0);
    const wasPlaying = localStorage.getItem('inkcraft-music-playing') === 'true';

    if (savedTrack && playlist.includes(savedTrack)) {
      audio.src = savedTrack;
      current = playlist.indexOf(savedTrack);
      audio.currentTime = savedTime || 0;
    } else {
      audio.src = playlist[current];
    }

    const nextIndex = () => (current + 1) % playlist.length;
    audioNext.src = playlist[nextIndex()];

    // === CROSSFADE ===
    audio.addEventListener('timeupdate', () => {
      if (audio.duration && audio.duration - audio.currentTime < 5 && !audioNext.isFading) {
        crossfade();
      }
    });

    function crossfade() {
      audioNext.isFading = true;
      const next = nextIndex();
      audioNext.src = playlist[next];
      audioNext.currentTime = 0;
      audioNext.play();

      fadeVolume(audioNext, 0, 0.5, 5000);
      fadeVolume(audio, audio.volume, 0, 5000, () => {
        audio.pause();
        audio.src = audioNext.src;
        audio.volume = 0.5;
        current = next;
        audioNext.isFading = false;
        audio.play();
      });
    }

    function fadeVolume(a, from, to, duration, callback) {
      const steps = 30;
      const stepTime = duration / steps;
      let count = 0;
      const delta = (to - from) / steps;
      a.volume = from;
      const interval = setInterval(() => {
        count++;
        a.volume = Math.min(Math.max(a.volume + delta, 0), 1);
        if (count >= steps) {
          clearInterval(interval);
          if (callback) callback();
        }
      }, stepTime);
    }

    // === Toggle + state ===
    window.addEventListener('message', (event) => {
      const msg = event.data;
      if (!msg || !msg.cmd) return;
      switch (msg.cmd) {
        case 'toggle':
          if (!isPlaying) {
            startPlayback();
          } else {
            audio.pause(); audioNext.pause();
            isPlaying = false;
            notifyParent();
          }
          break;
        case 'getState':
          notifyParent();
          break;
      }
    });

    function startPlayback() {
      audio.play().then(() => {
        isPlaying = true;
        notifyParent();
      }).catch(() => {
        // Retry autoplay if blocked
        setTimeout(() => {
          audio.play().then(() => {
            isPlaying = true;
            notifyParent();
          }).catch(() => {});
        }, 1000);
      });
    }

    function notifyParent() {
      window.parent.postMessage({ cmd: 'stateUpdate', isPlaying }, '*');
    }

    // === Resume playback after navigation ===
    if (wasPlaying) {
      startPlayback();
    } else {
      notifyParent();
    }

    // === Save playback state before unload ===
    function saveState() {
      localStorage.setItem('inkcraft-music-track', audio.src);
      localStorage.setItem('inkcraft-music-time', audio.currentTime);
      localStorage.setItem('inkcraft-music-playing', isPlaying);
    }
    window.addEventListener('beforeunload', saveState);

    // === Pause + auto-resume on tab switch ===
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        if (!audio.paused) {
          wasPlayingBeforeLeaving = true;
          saveState();
          audio.pause();
          audioNext.pause();
          isPlaying = false;
        }
      } else if (wasPlayingBeforeLeaving) {
        startPlayback();
        wasPlayingBeforeLeaving = false;
      }
    });
  </script>
</body>
</html>
